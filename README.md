# ESPHome 脉冲采集固件（ESP32 + pulse_counter 方案）

## 📌 项目简介

本项目基于 **ESPHome + ESP32 + TCRT5000 光电传感器**，  
通过 **pulse_counter** 方式对家用机械燃气表进行脉冲采集，实现：

- 燃气 **累计用气量（m³）**
- **高可靠、无重复计数**
- 支持 **Home Assistant 能源面板**
- 支持 **手动校准**
- 支持 **脉冲精度可调**

该方案适用于 **低速、慢变化的机械燃气表 / 水表**，相比 binary_sensor 方案具有更高的稳定性和长期准确性。

---

## 🧱 硬件说明

### 必要硬件
- ESP32（NodeMCU-32S 或同类）
- TCRT5000 光电传感器模块
- 机械式燃气表（带字轮 / 反光标记）

### 接线说明

| TCRT5000 | ESP32 |
|--------|------|
| DO | GPIO4 |
| VCC | 3.3V |
| GND | GND |

> ⚠️ 建议使用 **DO（数字输出）**，并在模块上调好电位器，使字轮经过时电平变化清晰。

---

## 🧠 设计思路（核心原理）

### 为什么使用 pulse_counter？

- TCRT5000 输出的是 **慢速、易抖动的光学信号**
- binary_sensor + delayed_on/off **容易重复触发**
- pulse_counter 内部使用 **硬件 PCNT 计数器 + 硬件中断**
- 非常适合 **燃气 / 水表这类低频脉冲计量**

### 工作流程概述

```
燃气表字轮转动
   ↓
TCRT5000 产生脉冲
   ↓
ESP32 PCNT 硬件计数器累计脉冲
   ↓
按 update_interval 周期结算
   ↓
换算为 m³ 并上报 HA
```

---

## 📐 计量逻辑说明

### 脉冲计数

- 使用 PCNT 硬件计数器
- **internal_filter** 在 ESP32 上最大为 13µs（硬件限制），  
  对慢速机械表来说，**软件累计 delta 防止多算**是关键
- 每次更新时，只处理 **新增脉冲（delta）**
- 换算公式：

```
新增用气量 = 新增脉冲数 × 每脉冲体积
```

---

## 🧩 Home Assistant 实体说明

### 1️⃣ 燃气累计用量

**实体名称**：`sensor.meter`  
- 单位：`m³`
- `device_class: gas`
- `state_class: total_increasing`
- 可直接用于 **HA 能源面板**

---

### 2️⃣ 脉冲体积设置（重要）

**实体名称**：`number.pulse_volume`

用于设置 **每个脉冲对应的气量**：

| 设置值 | 含义 |
|-----|-----|
| 0.01 | 1 脉冲 = 0.01 m³ |
| 0.005 | 1 脉冲 = 0.005 m³ |
| 0.001 | 1 脉冲 = 0.001 m³ |

> 📌 修改后立即生效，无需重启或重新烧录。

---

### 3️⃣ 手动校正用气量

**实体名称**：`number.gas_usage_correction`

用途：
- 初次部署对齐实体燃气表
- 长期运行后微调累计值

使用方法：
1. 查看实体燃气表当前读数
2. 将该值填入 `Gas Usage Correction`
3. 系统会立刻同步并清零输入框

---

## ⏱ 关于 update_interval

```yaml
update_interval: 60s
```

含义：

- **脉冲是实时计数的**
- 燃气读数是 **每 60 秒结算并更新一次**
- 不影响计量精度，仅影响显示刷新频率

推荐值：

| 场景 | 建议 |
|----|----|
| 仅累计用量 | 60s（推荐） |
| 显示瞬时流量 | 10s |
| 调试阶段 | 10–30s |

---

## 🔁 断电 / 重启行为说明

- 燃气累计量使用 `restore_value: yes`
- ESP 重启后：
  - 不会清零
  - 不会重复累计

> 软件层通过 `delta` 计算防止重复累计，即使 PCNT 在短时间内多计数也不会影响总量。

---

## ✅ 部署步骤建议

1. 烧录固件并上线 ESP
2. 在 Home Assistant 中发现设备
3. 设置：
   - `Pulse Volume`（每脉冲体积）
   - `Gas Usage Correction`（对齐实体表）
4. 连续运行 24–72 小时进行对比验证

---

## 📊 精度验证建议

记录以下数据进行比对：

| 时间 | 实体燃气表 | HA 显示 | 差值 |
|----|----|----|----|

正常情况下：
- 日误差应 < 0.2 m³
- 不应出现线性漂移

---

## 📎 免责声明

- 本项目为 **民用非计费级参考计量**
- 不可作为商业结算依据
- 请遵守当地燃气安全与改装规范
