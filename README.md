# ESPHome 脉冲采集固件（ESP32方案）

## 📌 项目简介

本项目基于 ESPHome，使用 **ESP32S + TCRT5000 光电传感器**，  
通过 **GPIO 中断 + 软件最小间隔防抖** 方式对家用机械燃气表进行脉冲采集，实现：

- 燃气 **累计用气量（m³）**
- **高可靠、无重复计数**
- 支持 **Home Assistant 能源面板**
- 支持 **手动校准**
- 支持 **自定义脉冲精度**
- 支持 **自定义最小脉冲间隔防抖**

该方案适用于 **低速、慢变化的机械燃气表 / 水表**。

---

## 🧱 硬件说明

### 必要硬件
- ESP32（NodeMCU-32S 或同类）
- TCRT5000 光电传感器模块
- 机械式燃气表（带字轮 / 反光标记）

### 接线说明

| TCRT5000 | ESP32 |
|--------|------|
| DO | GPIO4 |
| VCC | 3.3V |
| GND | GND |

> ⚠️ 建议使用 **DO（数字输出）**，并在模块上调好电位器，使字轮经过时电平变化清晰。

---

## 🏗 固件原理

1. **脉冲检测**：TCRT5000 光电传感器检测燃气表转动，通过 GPIO 触发 binary_sensor 中断。
2. **防抖逻辑**：在 lambda 中判断两次脉冲的时间间隔，低于最小间隔的脉冲被丢弃。
3. **累计统计**：合格脉冲通过 lambda 累加到总用气量，并实时发布到 HA。

---

## 📊 Home Assistant 实体说明

### 燃气用量

| 实体 | 说明 |
|----|----|
| `sensor.meter` | 燃气累计用量（m³），`device_class: gas`，`state_class: total_increasing` |

### 脉冲状态

| 实体 | 说明 |
|----|----|
| `binary_sensor.gas_pulse_state` | 当前是否检测到脉冲（实时指示） |

### 配置与校正

| 实体 | 说明 |
|----|----|
| `number.pulse_volume` | 每个脉冲对应的燃气体积（m³/脉冲） |

| 设置值 | 含义 |
|-----|-----|
| 0.01 | 1 脉冲 = 0.01 m³ |
| 0.005 | 1 脉冲 = 0.005 m³ |
| 0.001 | 1 脉冲 = 0.001 m³ |

> 📌 修改后立即生效，无需重启或重新烧录。

| 实体 | 说明 |
|----|----|
| `number.gas_usage_correction` | 手动校正累计燃气用量 |

用途：
- 初次部署对齐实体燃气表
- 长期运行后微调累计值

使用方法：
1. 查看实体燃气表当前读数
2. 将该值填入 `Gas Usage Correction`
3. 系统会立刻同步并清零输入框

| 实体 | 说明 |
|----|----|
| `number.pulse_min_interval` | 软件防抖最小脉冲间隔（ms） |

用途：
- 丢弃高频异常脉冲，避免重复计数

使用方法：
1. 观察记录燃气表最小位循环一圈最短时间（s）
2. 根据燃气表循环最短时间设置防抖间隔，建议值为最短循环时间*0.6
3. pulse_min_interval支持100~10000ms区间设置，步长100ms，默认值为2000ms
4. 修改后立即生效

---

## 🚀 使用步骤

1. 使用 ESPHome 编译并刷入固件
2. 设备上线并接入 Wi‑Fi
3. 在 Home Assistant 中添加设备
4. 设置：
   - `Pulse Volume`（按燃气表规格）
   - `Gas Usage Correction`（对齐表盘读数）
   - `pulse_min_interval`（自定义防抖）
5. 观察 `Gas Pulse State` 验证脉冲是否正常
6. 连续运行 24–72 小时进行对比验证

---

## 🔁 断电 / 重启行为说明

- 燃气累计量使用 `restore_value: yes`
- ESP 重启后：
  - 不会清零
  - 不会重复累计

---

## 📎 免责声明

- 本项目为 **民用非计费级参考计量**
- 不可作为商业结算依据
- 请遵守当地燃气安全与改装规范
