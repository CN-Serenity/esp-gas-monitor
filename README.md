# ESPHome 脉冲采集固件（ESP32方案）

## 📌 项目简介

本项目基于 ESPHome，使用 **ESP32 硬件脉冲计数器（PCNT） + TCRT5000 光电传感器**，  
通过 **pulse_counter** 方式对家用机械燃气表进行脉冲采集，实现：

- 燃气 **累计用气量（m³）**
- **高可靠、无重复计数**
- 支持 **Home Assistant 能源面板**
- 支持 **手动校准**
- 支持 **脉冲精度可调**

该方案适用于 **低速、慢变化的机械燃气表 / 水表**。

---

## 🧱 硬件说明

### 必要硬件
- ESP32（NodeMCU-32S 或同类）
- TCRT5000 光电传感器模块
- 机械式燃气表（带字轮 / 反光标记）

### 接线说明

| TCRT5000 | ESP32 |
|--------|------|
| DO | GPIO4 |
| VCC | 3.3V |
| GND | GND |

> ⚠️ 建议使用 **DO（数字输出）**，并在模块上调好电位器，使字轮经过时电平变化清晰。

---

## 🏗 固件架构说明

### 1️⃣ 脉冲累计（核心计量）

- 使用 `pulse_counter`（ESP32 PCNT）
- 负责**长期、稳定、精确**的脉冲累计
- 每个周期只结算「新增脉冲 delta」，避免重复计算
- 内部累计脉冲传感器已在 HA 中隐藏（internal）

### 2️⃣ 实时脉冲状态（可视化）

- 使用 `binary_sensor.gpio`
- 与 `pulse_counter` 共用 GPIO（`allow_other_uses: true`）
- 每次真实脉冲都会立即触发
- 通过 `delayed_off` 拉长显示时间，确保 HA 可见

---

## 📊 Home Assistant 实体说明

### 燃气用量

| 实体 | 说明 |
|----|----|
| `sensor.meter` | 燃气累计用量（m³），`device_class: gas`，`state_class: total_increasing` |

### 脉冲状态

| 实体 | 说明 |
|----|----|
| `binary_sensor.gas_pulse_state` | 当前是否检测到脉冲（实时指示） |

### 配置与校正

| 实体 | 说明 |
|----|----|
| `number.pulse_volume` | 每个脉冲对应的燃气体积（m³/脉冲） |

| 设置值 | 含义 |
|-----|-----|
| 0.01 | 1 脉冲 = 0.01 m³ |
| 0.005 | 1 脉冲 = 0.005 m³ |
| 0.001 | 1 脉冲 = 0.001 m³ |

> 📌 修改后立即生效，无需重启或重新烧录。

| 实体 | 说明 |
|----|----|
| `number.gas_usage_correction` | 手动校正累计燃气用量 |

用途：
- 初次部署对齐实体燃气表
- 长期运行后微调累计值

使用方法：
1. 查看实体燃气表当前读数
2. 将该值填入 `Gas Usage Correction`
3. 系统会立刻同步并清零输入框

---

## ⚙️ 工作逻辑简述

```text
燃气表产生脉冲
 ├─ binary_sensor.gpio → 实时显示“有脉冲”
 └─ pulse_counter.total → 累计脉冲数
            ↓
   新增脉冲 × 每脉冲体积
            ↓
      燃气累计用量（m³）
```

- 脉冲采集是**实时的**
- 用量统计是**周期结算的**
- 不影响精度，仅影响 HA 中刷新频率

---

## 🚀 使用步骤

1. 使用 ESPHome 编译并刷入固件
2. 设备上线并接入 Wi‑Fi
3. 在 Home Assistant 中添加设备
4. 设置：
   - `Pulse Volume`（按燃气表规格）
   - `Gas Usage Correction`（对齐表盘读数）
5. 观察 `Gas Pulse State` 验证脉冲是否正常

---

## 🔁 断电 / 重启行为说明

- 燃气累计量使用 `restore_value: yes`
- ESP 重启后：
  - 不会清零
  - 不会重复累计

> 软件层通过 `delta` 计算防止重复累计，即使 PCNT 在短时间内多计数也不会影响总量。

---

## ✅ 部署步骤建议

1. 烧录固件并上线 ESP
2. 在 Home Assistant 中发现设备
3. 设置：
   - `Pulse Volume`（脉冲精度）
   - `Gas Usage Correction`（对齐实体表）
4. 连续运行 24–72 小时进行对比验证

---

## 📎 免责声明

- 本项目为 **民用非计费级参考计量**
- 不可作为商业结算依据
- 请遵守当地燃气安全与改装规范
